---
title: "MCCHD Covid-19 initial data cleaning"
author: "Ethan Walker"
date: "Started 2 April 2020, Updated 21 April 2020"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, 
                      include = TRUE, warning = FALSE, message = FALSE)
```

```{r, message=FALSE}
library(tidyverse)
library(readxl)
library(naniar)
library(lubridate)
library(zoo)
library(eeptools)
library(plotly)
library(knitr)
jv_palette <- c("#330099","#CC0066","#FF6633", 
                 "#0099CC", "#FF9900","#CC6633",
                  "#FF3366", "#33CC99", "#33999")
```

C:/Users/ethan.walker/Box/Ethan Walker UM/R/covid19
```{r}
input_path <- c("C:/Users/ethan.walker/Box/Ethan Walker UM/R/covid19/")


covid_data_initial <- 
   read_xlsx(paste0(input_path, "Input/mcchd_covid_data_20200419.xlsx"), skip = 1,
                        col_names = c("dob", "gender", "zipcode", "healthcare_worker",
                                      "symptoms", "symptom_type", "symptom_onset_date",
                                      "test_date", "test_results", "test_lab", "last_exposure_date", 
                                      "release_date", "contact_with_case", "travel_hx",
                                      "hospitalized", "ventilated", "discharge_date",
                                      "chronic_conditions", "chronic_conditions_type",
                                      "number_contacts", "patient_died", 
                                      "patient_died_date", "contact_case_number",
                                      "community_spread", "epi_linked"),
                        col_types = c("date", "text", "text", "text",
                                      "text", "text", "date",
                                      "date", "text", "text", "date",
                                      "date", "text", "text",
                                      "text", "text", "date",
                                      "text", "text",
                                      "text", "text", 
                                      "date", "text",
                                      "text", "text"))
```


```{r}
covid_clean <- covid_data_initial %>% 
   filter(!is.na(dob)) %>% 
   rownames_to_column() %>% 
   mutate(case_number = as.numeric(rowname),
          dob = ymd(dob),
          age = round(age_calc(dob, units = "years"), digits = 1),
          age_group = cut(age, breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 110),
                          labels = c("0-9, 0.1", "10-19, 0.12", "20-29, 0.19", 
                                     "30-39, 0.14", "40-49, 0.12", "50-59, 0.11", 
                                     "60-69, 0.11", "70-79, 0.07", "80+, 0.03"), right = FALSE),
          age_group2 = cut(age, breaks = c(0, 18, 65, 110),
                          labels = c("<18", "18-64", "65+"), right = FALSE)) %>% 
   separate(age_group, c("age_group", "age_group_percent"), sep = ", ") %>% 
   mutate(age_group_percent = as.numeric(age_group_percent),
          county_pop = as.numeric(119000)) %>% 
   select(case_number, dob, age, age_group, age_group_percent, age_group2, 
          county_pop, gender:epi_linked) %>% 
   mutate_if(is.character, tolower) %>% 
   mutate(symptom_cough = grepl("COUGH|MILD COUGH", symptom_type, ignore.case = TRUE),
          symptom_fever = grepl("FEVER", symptom_type, ignore.case = TRUE),
          symptom_fatigue = grepl("FATIGUE", symptom_type, ignore.case = TRUE),
          symptom_nv = grepl("NAUSEA|N/V|N/V/D", symptom_type, ignore.case = TRUE),
          symptom_sorethroat = grepl("SORE THROAT", symptom_type, ignore.case = TRUE),
          symptom_chills = grepl("CHILL", symptom_type, ignore.case = TRUE),
          symptom_sob = grepl("SOB", symptom_type, ignore.case = TRUE),
          symptom_lethargy = grepl("LETHARGY", symptom_type, ignore.case = TRUE),
          symptom_diarrhea = grepl("DIARRHEA|N/V/D", symptom_type, ignore.case = TRUE),
          symptom_sneezing = grepl("SNEEZING", symptom_type, ignore.case = TRUE),
          symptom_congestion = grepl("CONGESTION", symptom_type, ignore.case = TRUE),
          symptom_runny_nose = grepl("RUNNY NOSE", symptom_type, ignore.case = TRUE),
          symptom_body_aches = grepl("BODY ACHES|ACHES|ACHINESS", symptom_type, ignore.case = TRUE),
          symptom_headache = grepl("HEADACHE|HA|H/A", symptom_type, ignore.case = TRUE),
          symptom_chest_pain = grepl("CHEST PAIN|CHEST TIGHTNESS", symptom_type, ignore.case = TRUE),
          symptom_taste_smell = grepl("TASTE|SMELL", symptom_type, ignore.case = TRUE),
          symptom_fever_chill = grepl("FEVER|CHILL|CHILLS|NIGHT SWEAT", symptom_type, ignore.case = TRUE),
          symptom_fatigue_lethargy = grepl("FATIGUE|LETHARGY", symptom_type, ignore.case = TRUE),
          symptom_nv_diarrhea = grepl("NAUSEA|N/V|DIARRHEA|N/V/D|ABDOMINAL|STOMACH", symptom_type, ignore.case = TRUE),
          symptom_aches = grepl("BODY ACHES|HEADACHE|MYALGIA|HA|H/A|ACHES", symptom_type, ignore.case = TRUE),
          symptom_sinus_throat = grepl("CONGESTION|RUNNY NOSE|SNEEZING|SORE THROAT|RHINORRHEA|SCRATCHY THROAT|THROAT|SINUS", 
                                       symptom_type, ignore.case = TRUE),
          symptom_respiratory = grepl("COUGH|MILD COUGH|SOB|COLD SX", symptom_type, ignore.case = TRUE)) %>% 
   separate(healthcare_worker, c("healthcare_worker", "healthcare_worker_comment"), sep = " ") %>% 
   separate(travel_hx, c("travel_hx", "travel_hx_comment"), sep = " ") %>% 
   separate(hospitalized, c("hospitalized", "hospitalized_comment"), sep = " ") %>% 
   separate(ventilated, c("ventilated", "ventilated_comment"), sep = "o, ") %>% 
   replace_with_na(replace = list(number_contacts = "UNKNOWN")) %>% 
   replace_with_na(replace = list(epi_linked = "UNKNOWN")) %>% 
   mutate(symptom_onset_date = ymd(symptom_onset_date),
          release_date = ymd(release_date),
          discharge_date = ymd(discharge_date),
          patient_died_date = ymd(patient_died_date),
          test_date = ymd(test_date),
          last_exposure_date = ymd(last_exposure_date),
          number_contacts = as.numeric(number_contacts),
          number_contacts_categorical = cut(number_contacts, breaks = c(0, 5, 10, 50),
                                            labels = c("0 to 5", "5 to 10", "10+"),
                                            right = FALSE)) %>% 
   mutate(case = 1,
          gender = factor(gender, levels = c("m", "f"),
                          labels = c("Male", "Female")),
          contact_with_case = factor(contact_with_case,
                                     levels = c("y", "n", "unknown"),
                                     labels = c("Yes", "No", "Unknown")),
          healthcare_worker = factor(healthcare_worker,
                                     levels = c("y", "n"),
                                     labels = c("Yes", "No")),
          travel_hx = factor(travel_hx, levels = c("y", "n"),
                             labels = c("Yes", "No")),
          hospitalized = factor(hospitalized, levels = c("y", "n"),
                             labels = c("Yes", "No")),
          ventilated = factor(ventilated,
                                     levels = c("y", "n", "n/a"),
                                     labels = c("Yes", "No", "N/A")),
          chronic_conditions = factor(chronic_conditions, levels = c("y", "n"),
                             labels = c("Yes", "No")),
          community_spread = if_else(travel_hx == "No" & contact_with_case == "No",
                                     "Yes", "No"),
          patient_died = factor(patient_died, levels = c("y", "n"),
                             labels = c("Yes", "No")),
          epi_linked = factor(epi_linked, levels = c("y", "n", "unknown"),
                             labels = c("Yes", "No", "Unknown"))) %>% 
   replace_with_na(replace = list(ventilated = "N/A")) %>% 
   mutate(symptom_test_diff = as.duration(interval(symptom_onset_date, test_date)),
          symptom_test_diff = as.numeric(symptom_test_diff)/86400,
          mean_symptom_test_diff = mean(symptom_test_diff, na.rm = TRUE),
          symptom_onset_date_new = if_else(is.na(symptom_onset_date), 
                                       test_date - mean_symptom_test_diff,
                                       symptom_onset_date),
          symptom_onset_date_new = ymd(symptom_onset_date_new),
          symptom_onset_date_indicator = if_else(is.na(symptom_onset_date),
                                                 "Estimated from test date",
                                                 "Estimated by self-report")) 
```

```{r}
output_path <- c("C:/Users/ethan.walker/Box/Ethan Walker UM/R/covid19/")

write_rds(covid_clean, paste0(output_path, "Output/covid_data_clean.rds"))
```


---
title: "MCCHD Covid-19 model fit and doubling time"
author: "Ethan Walker, University of Montanta"
date: "Started 6 April 2020, Updated 7 April 2020"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, 
                      include = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 8, fig.height = 6)
```

```{r, message=FALSE}
library(tidyverse)
library(readxl)
library(naniar)
library(lubridate)
library(zoo)
library(eeptools)
library(knitr)
library(incidence)
library(EpiEstim)
library(earlyR)
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
               "#0072B2", "#D55E00", "#CC79A7")
```
## The following code is mostly revised from:

https://www.r-bloggers.com/covid-19-epidemiology-with-r/

https://www.repidemicsconsortium.org/earlyR/

https://cran.r-project.org/web/packages/incidence/vignettes/overview.html

https://cran.r-project.org/web/packages/EpiEstim/EpiEstim.pdf

## Load dataset

```{r}
covid_data <- read_rds("Output/covid_data_clean.rds")
```

Calculate daily incidence, including a date for days with no new cases.

## Simple plot of daily incidence (Epi curve)

```{r}
covid_incidence <- incidence(covid_data$symptom_onset_date_new)

plot(covid_incidence)
```

Serial interval = time between the date of onset of symptoms for a case and 
the dates of onset for any secondary cases that case gives rise to.

Covid-19 serial interval estimated here:

https://www.medrxiv.org/content/medrxiv/early/2020/03/20/2020.02.19.20025452.full.pdf 

```{r}
serial_interval_mean <- 4
serial_interval_sd <- 4.75
```

Using MCCHD Covid data and serial interval data from above, 
calculate reproduction number (R) using maximum-likelihood estimate.
R = mean number of new cases each infected person give rise to

```{r}
r_results <- get_R(covid_incidence, 
                   si_mean = serial_interval_mean,
                   si_sd = serial_interval_sd)
#r_results

plot(r_results)
```

Using results from above, calculate force of infection, which is
the rate at which susceptible individuals acquire disease
```{r}
plot(r_results, "lambdas")
```

We can also simulate a large sample of likely R values, and then compute 
statistics on this sample:
```{r}
sample_results <- sample_R(r_results, 1000)
summary(sample_results)
quantile(sample_results) # quartiles
quantile(sample_results, c(0.025, 0.975)) # 95% credibility interval

hist(sample_results, border = "grey", col = "navy",
     xlab = "Values of R",
     main = "Sample of likely R values")
```

We have limited data to calculate doubling time, but that can be done here:
```{r}
fit_results <- incidence::fit(covid_incidence)
fit_results

# doubling time = 29 days

plot(fit_results)

plot(covid_incidence) %>% 
   add_incidence_fit(fit_results)
```


```{r, eval=FALSE, include=FALSE, echo=FALSE}
# Method of calculating R based on Erin L method below

model_data <- covid_data %>% 
   mutate(total_cases = n()) %>% 
   group_by(symptom_onset_date) %>% 
   mutate(daily_incidence = n()) %>% 
   ungroup() %>% 
   distinct(symptom_onset_date, .keep_all = TRUE) %>% 
   arrange(symptom_onset_date)


estimate_results <- estimate_R(model_data$daily_incidence, method="parametric_si", 
                               config = make_config(list(mean_si = serial_interval_mean, 
                                                         std_si = serial_interval_sd)))
estimate_results


estimate_results <- estimate_R(model_data$daily_incidence, method="parametric_si", 
                               config = make_config(list(mean_si = serial_interval_mean, 
                                                         std_si = serial_interval_sd)))
estimate_results


estimate_plots <- estimate_R_plots(estimate_results, what = "R")
estimate_plots
```


```{r, eval=FALSE, include=FALSE, echo=FALSE}
# Estimating R0 from case data for Montana
# Casey Day, 4/4/20
# Updated: 4/6/2020 (ell)
# Data from Erin Landguth

SImn = 3.96
SIsd = 4.75

# County level data
be_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1)
br_cases <- c(0,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,3,3,3,3,3,3,4,4,4,4)
ca_cases <- c(0,0,0,0,0,0,0,0,0,3,3,3,3,5,6,7,7,7,8,9,9,11,11,11,11,11)
cb_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,2)
dl_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,3,3,3,3,3,3,3)
fl_cases <- c(0,0,0,0,0,0,0,0,2,2,2,4,4,5,6,6,7,9,11,11,17,18,20,23,25,31)
ga_cases <- c(0,1,1,1,1,2,3,3,3,7,9,15,18,23,38,45,57,66,68,73,79,93,101,109,115,118)
gl_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1)
hl_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1)
je_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,2,2,2,2,2,2,2,2,2,2,2)
la_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,3,3,3,4,4,4,4,5)
lc_cases <- c(0,0,0,0,0,0,0,0,3,3,3,3,3,4,7,9,10,11,12,13,13,13,13,14,14,15)
lb_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1)
li_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,3,3,4,5,5,6,6,6,6,7,7)
ma_cases <- c(0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,3,4,4,6,6,6,6,6,6,9,9)
me_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1)
mi_cases <- c(0,0,2,2,2,3,4,4,4,4,4,6,6,6,8,9,11,12,12,14,15,17,17,19,21,24)
mu_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1)
pa_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,2,3,3,5,6,6,6,6,6)
ra_cases <- c(0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2)
ro_cases <- c(0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)
sb_cases <- c(0,1,1,1,1,1,1,1,1,2,2,3,4,5,8,9,10,10,11,11,11,11,11,11,11,11)
to_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,4,4,5,6,6,6,6,12,15,15,15) 
ys_cases <- c(0,1,1,1,2,2,2,5,5,5,6,7,8,13,19,23,26,26,29,31,32,35,38,38,40,47)
dates <- seq(as.Date("2020/3/12"), as.Date("2020/4/6"), "days")

co_cases <- as.data.frame(cbind(dates, br_cases, ca_cases, cb_cases, dl_cases, fl_cases, ga_cases, gl_cases, hl_cases, je_cases,
                  la_cases, lc_cases, lb_cases, li_cases, ma_cases, me_cases, mi_cases, mu_cases,
                  pa_cases, ra_cases, ro_cases, sb_cases, to_cases, ys_cases))

co_cases_nodates <- as.data.frame(cbind(br_cases, ca_cases, cb_cases, dl_cases, fl_cases, ga_cases, gl_cases, hl_cases, je_cases,
                                la_cases, lc_cases, lb_cases, li_cases, ma_cases, me_cases, mi_cases, mu_cases,
                                pa_cases, ra_cases, ro_cases, sb_cases, to_cases, ys_cases))


reg1 <- c(0., 0., 0., 0., 0., 0., 0., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
        1., 1., 1., 1., 1., 1., 1.,1.,1.)
reg2 <- c(0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  3.,  3.,  3.,  3.,
          7.,  9., 13., 13., 14., 16., 17., 17., 19., 26., 29.,29.,29.)
reg3 <- c( 0.,  1.,  1.,  1.,  2.,  2.,  2.,  5.,  5.,  5.,  6.,  7.,  8.,
          13., 19., 23., 26., 26., 30., 32., 34., 37., 40., 40.,42.,50.)
reg4 <- c(0.,   3.,   3.,   3.,   3.,   4.,   5.,   5.,   9.,  14.,  16.,
           23.,  29.,  37.,  61.,  72.,  90., 101., 109., 115., 123., 138.,
           147., 156.,165.,169.)
reg5 <- c(0.,  0.,  2.,  2.,  2.,  3.,  4.,  4.,  7.,  7.,  7., 11., 11.,
          13., 16., 20., 24., 29., 32., 34., 42., 46., 48., 54.,59.,69.)
mt_cases <- c(0.,   4.,   6.,   6.,   7.,   9.,  11.,  15.,  22.,  30.,  33.,
              45.,  52.,  71., 106., 129., 154., 171., 188., 199., 217., 241.,
              262., 280., 297.,319.)

reg_cases <- as.data.frame(cbind(dates,reg1,reg2,reg3,reg4,reg5,mt_cases))
reg_cases_nodates <- as.data.frame(cbind(reg1,reg2,reg3,reg4,reg5,mt_cases))

#Load packages
#library(R0)
library(EpiEstim)
#Basic example for Gallatin county. R is estimated based on a sliding time window
#with 1-week as default, but this can be adjusted
# mean si and sd si are estimated from https://wwwnc.cdc.gov/eid/article/26/6/20-0357_article
# I couldn't get the non parametric method to work because it requires an si distribution, so 
# all results are parametric
res_parametric_si <- estimate_R(co_cases$mi_cases, 
                                method="parametric_si",
                                config = make_config(list(
                                  mean_si = SImn, 
                                  std_si = SIsd)))
#plot results
plot(res_parametric_si, legend = FALSE)

# Creae a list where each element contains the data frame output from estimate_R()
R_estimates <- apply(co_cases_nodates, MARGIN = 2, function(x) estimate_R(x, 
                                                                    method="parametric_si",
                                                                    config = make_config(list(
                                                                      mean_si = SImn, 
                                                                      std_si = SIsd))))
R_estimates_REG <- apply(reg_cases_nodates, MARGIN = 2, function(x) estimate_R(x, 
                                                                          method="parametric_si",
                                                                          config = make_config(list(
                                                                            mean_si = SImn, 
                                                                            std_si = SIsd))))



#Plot results for Gallatin county
plot(R_estimates$mi_cases, legend = FALSE)

reg1Mean <- R_estimates_REG$reg1$R$Mean[length(R_estimates_REG$reg1$R$Mean)]
reg1L <- R_estimates_REG$reg1$R$`Quantile.0.975(R)`[length(R_estimates_REG$reg1$R$Mean)]
reg1R <- R_estimates_REG$reg1$R$`Quantile.0.025(R)`[length(R_estimates_REG$reg1$R$Mean)]

reg2Mean <- R_estimates_REG$reg2$R$Mean[length(R_estimates_REG$reg2$R$Mean)]
reg2L <- R_estimates_REG$reg2$R$`Quantile.0.975(R)`[length(R_estimates_REG$reg1$R$Mean)]
reg2R <- R_estimates_REG$reg2$R$`Quantile.0.025(R)`[length(R_estimates_REG$reg1$R$Mean)]

reg3Mean <- R_estimates_REG$reg3$R$Mean[length(R_estimates_REG$reg3$R$Mean)]
reg3L <- R_estimates_REG$reg3$R$`Quantile.0.975(R)`[length(R_estimates_REG$reg1$R$Mean)]
reg3R <- R_estimates_REG$reg3$R$`Quantile.0.025(R)`[length(R_estimates_REG$reg1$R$Mean)]

reg4Mean <- R_estimates_REG$reg4$R$Mean[length(R_estimates_REG$reg4$R$Mean)]
reg4L <- R_estimates_REG$reg4$R$`Quantile.0.975(R)`[length(R_estimates_REG$reg1$R$Mean)]
reg4R <- R_estimates_REG$reg4$R$`Quantile.0.025(R)`[length(R_estimates_REG$reg1$R$Mean)]

reg5Mean <- R_estimates_REG$reg5$R$Mean[length(R_estimates_REG$reg5$R$Mean)]
reg5L <- R_estimates_REG$reg5$R$`Quantile.0.975(R)`[length(R_estimates_REG$reg1$R$Mean)]
reg5R <- R_estimates_REG$reg5$R$`Quantile.0.025(R)`[length(R_estimates_REG$reg1$R$Mean)]

beRMean <- R_estimates$be_cases$R$Mean[length(R_estimates$be_cases$R$Mean)]
brRMean<- R_estimates$br_cases$R$Mean[length(R_estimates$br_cases$R$Mean)]
caRMean<- R_estimates$ca_cases$R$Mean[length(R_estimates$ca_cases$R$Mean)]
cbRMean<- R_estimates$cb_cases$R$Mean[length(R_estimates$cb_cases$R$Mean)]
dlRMean<- R_estimates$dl_cases$R$Mean[length(R_estimates$dl_cases$R$Mean)]
flRMean<- R_estimates$fl_cases$R$Mean[length(R_estimates$fl_cases$R$Mean)]
gaRMean<- R_estimates$ga_cases$R$Mean[length(R_estimates$ga_cases$R$Mean)]
glRMean<- R_estimates$gl_cases$R$Mean[length(R_estimates$gl_cases$R$Mean)]
hlRMean<- R_estimates$hl_cases$R$Mean[length(R_estimates$hl_cases$R$Mean)]
jeRMean<- R_estimates$je_cases$R$Mean[length(R_estimates$je_cases$R$Mean)]
laRMean<- R_estimates$la_cases$R$Mean[length(R_estimates$la_cases$R$Mean)]
lcRMean<- R_estimates$lc_cases$R$Mean[length(R_estimates$lc_cases$R$Mean)]
lbRMean<- R_estimates$lb_cases$R$Mean[length(R_estimates$lb_cases$R$Mean)]
liRMean<- R_estimates$li_cases$R$Mean[length(R_estimates$li_cases$R$Mean)]
maRMean<- R_estimates$ma_cases$R$Mean[length(R_estimates$ma_cases$R$Mean)]
meRMean<- R_estimates$me_cases$R$Mean[length(R_estimates$me_cases$R$Mean)]
miRMean<- R_estimates$mi_cases$R$Mean[length(R_estimates$mi_cases$R$Mean)]
muRMean<- R_estimates$mu_cases$R$Mean[length(R_estimates$mu_cases$R$Mean)]
paRMean<- R_estimates$pa_cases$R$Mean[length(R_estimates$pa_cases$R$Mean)]
raRMean<- R_estimates$ra_cases$R$Mean[length(R_estimates$ra_cases$R$Mean)]
roRMean<- R_estimates$ro_cases$R$Mean[length(R_estimates$ro_cases$R$Mean)]
sbRMean<- R_estimates$sb_cases$R$Mean[length(R_estimates$sb_cases$R$Mean)]
toRMean<- R_estimates$to_cases$R$Mean[length(R_estimates$to_cases$R$Mean)] 
ysRMean<- R_estimates$ys_cases$R$Mean[length(R_estimates$ys_cases$R$Mean)]
```


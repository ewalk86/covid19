---
title: "State of Montana Covid-19 R-values, doubling time, and plots"
author: "Ethan Walker"
date: "Started 10 April 2020, Updated 10 April 2020"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, 
                      include = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 8, fig.height = 6)
```

```{r, message=FALSE}
library(tidyverse)
library(readxl)
library(naniar)
library(lubridate)
library(zoo)
library(eeptools)
library(knitr)
library(incidence)
library(EpiEstim)
library(earlyR)
library(projections)
library(distcrete)
library(epitrix)
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
               "#0072B2", "#D55E00", "#CC79A7")
```

# Prep case data and bind with dates
```{r}
be_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1)
br_cases <- c(0,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,3,3,3,3,3,3,4,4,4,4,4,4,4)
ca_cases <- c(0,0,0,0,0,0,0,0,0,3,3,3,3,5,6,7,7,7,8,9,9,11,11,11,11,11,11,11,12)
cb_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,2,2,3,3)
dl_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,3,3,3,3,3,3,3,3,3,4)
fl_cases <- c(0,0,0,0,0,0,0,0,2,2,2,4,4,5,6,6,7,9,11,11,17,18,20,23,25,31,31,31,34)
ga_cases <- c(0,1,1,1,1,2,3,3,3,7,9,15,18,23,38,45,57,66,68,73,79,93,101,109,115,118,118,120,128)
gl_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,2,3)
hl_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)
je_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2)
la_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,3,3,3,4,4,4,4,5,5,5,6)
lc_cases <- c(0,0,0,0,0,0,0,0,3,3,3,3,3,4,7,9,10,11,12,13,13,13,13,14,14,15,15,16,16)
lb_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1)
li_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,3,3,4,5,5,6,6,6,6,7,7,7,7,7)
ma_cases <- c(0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,3,4,4,6,6,6,6,6,6,8,8,8,8,8)
me_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)
mi_cases <- c(0,0,2,2,2,3,4,4,4,4,4,6,6,6,8,9,11,12,12,14,15,17,17,19,21,24,24,25,26)
mu_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1)
pa_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,2,3,3,5,6,6,6,6,6,6,7,7)
ra_cases <- c(0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,3,3)
ri_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2)
ro_cases <- c(0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2)
sb_cases <- c(0,1,1,1,1,1,1,1,1,2,2,3,4,5,8,9,10,10,11,11,11,11,11,11,11,11,11,11,11)
st_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1)
to_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,4,4,5,6,6,6,6,12,15,15,15,15,17,18) 
ys_cases <- c(0,1,1,1,2,2,2,5,5,5,6,7,8,13,19,23,26,26,29,31,32,35,38,38,40,47,47,48,52)

reg1 <- c(0., 0., 0., 0., 0., 0., 0., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
       1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 2.,3.)
reg2 <- c( 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  3.,  3.,  3.,  3.,
        7.,  9., 13., 13., 14., 16., 17., 17., 19., 26., 29., 29., 29.,
        29., 32.,35.)
reg3 <- c( 0.,  1.,  1.,  1.,  2.,  2.,  2.,  5.,  5.,  5.,  6.,  7.,  8.,
        13., 19., 23., 26., 26., 30., 32., 34., 37., 40., 40., 42., 50.,
        50., 52.,57.)
reg4 <- c(  0.,   3.,   3.,   3.,   3.,   4.,   5.,   5.,   9.,  14.,  16.,
         23.,  29.,  37.,  61.,  72.,  90., 101., 109., 115., 123., 138.,
         147., 156., 164., 168., 168., 173.,182.)
reg5 <- c( 0.,  0.,  2.,  2.,  2.,  3.,  4.,  4.,  7.,  7.,  7., 11., 11.,
        13., 16., 20., 24., 29., 32., 34., 42., 46., 48., 54., 59., 69.,
        69., 71.,76.)
mt_cases <- c(  0.,   4.,   6.,   6.,   7.,   9.,  11.,  15.,  22.,  30.,  33.,
         45.,  52.,  71., 106., 129., 154., 171., 188., 199., 217., 241.,
         262., 281., 296., 318., 318., 330., 353. )

dates <- as.data.frame(seq(ymd("2020-03-12"), ymd("2020-04-09"), by = "1 day")) %>% 
   mutate(case_date = `seq(ymd("2020-03-12"), ymd("2020-04-09"), by = "1 day")`) %>% 
   select(case_date)

co_cases <- as.data.frame(cbind(br_cases, ca_cases, cb_cases, dl_cases, fl_cases, ga_cases, gl_cases, hl_cases, je_cases,
                  la_cases, lc_cases, lb_cases, li_cases, ma_cases, me_cases, mi_cases, mu_cases,
                  pa_cases, ra_cases, ro_cases, sb_cases, to_cases, ys_cases))

co_cases_date <- cbind(dates, co_cases)

reg_cases <- as.data.frame(cbind(reg1,reg2,reg3,reg4,reg5,mt_cases))

reg_cases_date <- cbind(dates, reg_cases)

serial_interval_mean <- 4
serial_interval_sd <- 4.75
```

# Function to plot R (using earlyR) and incidence data
```{r}
incidence_function <- function(area, reg_name, data = reg_cases_date) {

analysis_data <- data %>% 
   rename(area_cases = area) %>% 
   select(case_date, area_cases) %>% 
   mutate(incidence_cases = if_else(area_cases > 0 & lag(area_cases) != 0,
                                    abs(lag(area_cases) - area_cases), area_cases),
          sum_cases = sum(incidence_cases)) 

incidence_dates <<- as.data.frame(rep(analysis_data$case_date, 
                                     times = analysis_data$incidence_cases)) %>% 
   rename(case_date = `rep(analysis_data$case_date, times = analysis_data$incidence_cases)`)

incidence_data <<- incidence(dates = incidence_dates$case_date)


# find and plot r value
r_results <- get_R(incidence_data, 
                   si_mean = serial_interval_mean,
                   si_sd = serial_interval_sd)
plot(r_results, main = reg_name)


# find doubing time and model fit
fit_results <- incidence::fit(incidence_data)

# plot line of fit
#plot(fit_results)

# plot line of fit over epi curve
plot(incidence_data) %>% 
   add_incidence_fit(fit_results) +
   labs(title = reg_name)

}
```

# Use earlyR to calculate R0
```{r}
# select county or region
incidence_function("mt_cases", "State of Montana")
incidence_function("reg1", "Region 1")
incidence_function("reg2", "Region 2")
incidence_function("reg3", "Region 3")
incidence_function("reg4", "Region 4")
incidence_function("reg5", "Region 5")
```

# Function for doubling time
```{r}
doubing_function <- function(area, reg_name, data = reg_cases_date) {

analysis_data <- data %>% 
   rename(area_cases = area) %>% 
   select(case_date, area_cases) %>% 
   mutate(incidence_cases = if_else(area_cases > 0 & lag(area_cases) != 0,
                                    abs(lag(area_cases) - area_cases), area_cases),
          sum_cases = sum(incidence_cases)) 

incidence_dates <<- as.data.frame(rep(analysis_data$case_date, 
                                     times = analysis_data$incidence_cases)) %>% 
   rename(case_date = `rep(analysis_data$case_date, times = analysis_data$incidence_cases)`)

incidence_data <<- incidence(dates = incidence_dates$case_date)

plot(incidence_data)

# find doubing time and model fit
fit_results <- incidence::fit(incidence_data)
doubling_time <- round(fit_results$info$doubling)
doubling_time <- paste0("Doubling time = ", doubling_time, " days for ", reg_name)
doubling_time

}
```

# Print doubling time
```{r}
# select county or region
doubing_function("mt_cases", "State of Montana")
#doubing_function("reg1", "Reg 1")
doubing_function("reg2", "Region 2")
doubing_function("reg3", "Region 3")
doubing_function("reg4", "Region 4")
doubing_function("reg5", "Region 5")
```


# Function using EpiEstim to calculate R on rolling weekly basis
```{r}
incidence_function <- function(area, reg_name, data = reg_cases_date) {

analysis_data <- data %>% 
   rename(area_cases = area) %>% 
   select(case_date, area_cases) %>% 
   mutate(incidence_cases = if_else(area_cases > 0 & lag(area_cases) != 0,
                                    abs(lag(area_cases) - area_cases), area_cases),
          sum_cases = sum(incidence_cases)) 

incidence_dates <<- as.data.frame(rep(analysis_data$case_date, 
                                     times = analysis_data$incidence_cases)) %>% 
   rename(case_date = `rep(analysis_data$case_date, times = analysis_data$incidence_cases)`)

incidence_data <<- incidence(dates = incidence_dates$case_date)

plot(incidence_data)

# calculat R value
estimate_results <- estimate_R(incidence_data, method="parametric_si", 
                               config = make_config(list(mean_si = serial_interval_mean, 
                                                         std_si = serial_interval_sd)))
#estimate_results

estimate_plots <- estimate_R_plots(estimate_results, what = "R")
estimate_plots

}
```

# R-value plots using EpiEstim
```{r}
# select county or region
incidence_function("mt_cases", "State of Montana")
incidence_function("reg1", "Region 1")
incidence_function("reg2", "Region 2")
incidence_function("reg3", "Region 3")
incidence_function("reg4", "Region 4")
incidence_function("reg5", "Region 5")
```



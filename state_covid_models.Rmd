---
title: "State of Montana Covid-19 R-values, doubling time, and plots"
author: "Ethan Walker"
date: "Data as of April 15, 2020"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, 
                      include = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 8, fig.height = 6)
```

```{r, message=FALSE}
library(tidyverse)
library(readxl)
library(naniar)
library(lubridate)
library(zoo)
library(eeptools)
library(knitr)
library(incidence)
library(EpiEstim)
library(earlyR)
library(projections)
library(distcrete)
library(epitrix)
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
               "#0072B2", "#D55E00", "#CC79A7")
```


```{r}
# Prep case data and bind with dates

be_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1)
bh_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,2,2)
br_cases <- c(0,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4)
ca_cases <- c(0,0,0,0,0,0,0,0,0,3,3,3,3,5,6,7,7,7,8,9,9,11,11,11,11,11,11,11,12,12,13,13,13,13,13)
cb_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,2,2,3,3,6,6,6,6,6,6)
dl_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3)
fl_cases <- c(0,0,0,0,0,0,0,0,2,2,2,4,4,5,6,6,7,9,11,11,17,18,20,23,25,31,31,31,34,34,34,34,36,36,37)
ga_cases <- c(0,1,1,1,1,2,3,3,3,7,9,15,18,23,38,45,57,66,68,73,79,93,101,109,115,118,118,120,128,134,135,138,138,138,139)
gl_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,2,3,3,3,3,4,4,4)
go_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1)
hl_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)
je_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2)
la_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,3,3,3,4,4,4,4,5,5,5,5,5,5,5,5,5,5)
lc_cases <- c(0,0,0,0,0,0,0,0,3,3,3,3,3,4,7,9,10,11,12,13,13,13,13,14,14,15,15,16,16,16,16,16,16,16,16)
lb_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)
li_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,3,3,4,5,5,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7)
ma_cases <- c(0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,3,4,4,6,6,6,6,6,6,8,8,8,8,8,8,8,8,8,8,8)
me_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)
mi_cases <- c(0,0,2,2,2,3,4,4,4,4,4,6,6,6,8,9,11,12,12,14,15,17,17,19,21,24,24,25,26,26,29,30,30,30,30)
mu_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1)
pa_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,2,3,3,5,6,6,6,6,6,6,7,7,7,7,7,7,7,7)
po_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1)
ra_cases <- c(0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,3,3,3,3,3,5,5,5)
ri_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,3,3,3,3,3)
ro_cases <- c(0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,3,3,3,3,4)
sb_cases <- c(0,1,1,1,1,1,1,1,1,2,2,3,4,5,8,9,10,10,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11)
st_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1)
to_cases <- c(0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,4,4,5,6,6,6,6,12,15,15,15,15,17,18,18,20,25,26,26,26) 
ys_cases <- c(0,1,1,1,2,2,2,5,5,5,6,7,8,13,19,23,26,26,29,31,32,35,38,38,40,47,47,48,52,55,57,58,59,63,64)

reg1 <- c(0., 0., 0., 0., 0., 0., 0., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
        1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 4., 4., 4., 6., 6., 6., 6.,
        7.)
reg2 <- c(0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  3.,  3.,  3.,  3.,
         7.,  9., 13., 13., 14., 16., 17., 17., 19., 26., 29., 29., 29.,
        29., 32., 35., 35., 38., 43., 45., 45., 46.)
reg3 <- c(0.,  1.,  1.,  1.,  2.,  2.,  2.,  5.,  5.,  5.,  6.,  7.,  8.,
        13., 19., 23., 26., 26., 30., 32., 34., 37., 40., 40., 42., 50.,
        50., 52., 57., 64., 67., 68., 69., 74., 75.)
reg4 <- c(0.,   3.,   3.,   3.,   3.,   4.,   5.,   5.,   9.,  14.,  16.,
         23.,  29.,  37.,  61.,  72.,  90., 101., 109., 115., 123., 138.,
        147., 157., 165., 169., 169., 173., 181., 187., 188., 191., 191.,
        191., 192.)
reg5 <- c(0.,  0.,  2.,  2.,  2.,  3.,  4.,  4.,  7.,  7.,  7., 11., 11.,
        13., 16., 20., 24., 29., 32., 34., 42., 46., 48., 54., 59., 69.,
        69., 71., 75., 75., 78., 79., 83., 83., 84.)
mt_cases <- c(0.,   4.,   6.,   6.,   7.,   9.,  11.,  15.,  22.,  30.,  33.,
         45.,  52.,  71., 106., 129., 154., 171., 188., 199., 217., 241.,
        262., 281., 296., 318., 318., 332., 352., 365., 377., 387., 394.,
        399., 404.)

dates <- as.data.frame(seq(ymd("2020-03-12"), ymd("2020-04-15"), by = "1 day")) %>% 
   mutate(case_date = `seq(ymd("2020-03-12"), ymd("2020-04-15"), by = "1 day")`) %>% 
   select(case_date)

co_cases <- as.data.frame(cbind(be_cases, bh_cases, br_cases, ca_cases, cb_cases, 
                                dl_cases, fl_cases, ga_cases, gl_cases, go_cases, 
                                hl_cases, je_cases, la_cases, lc_cases, lb_cases, 
                                li_cases, ma_cases, me_cases, mi_cases, mu_cases, 
                                pa_cases, po_cases, ra_cases, ri_cases, ro_cases, 
                                sb_cases, st_cases, to_cases, ys_cases))

co_cases_date <- cbind(dates, co_cases)

reg_cases <- as.data.frame(cbind(reg1,reg2,reg3,reg4,reg5,mt_cases))

reg_cases_date <- cbind(dates, reg_cases)

serial_interval_mean <- 4
serial_interval_sd <- 4.75
```


```{r}
# Function to plot R (using earlyR) and incidence data

incidence_function <- function(area, reg_name, data = reg_cases_date) {

analysis_data <- data %>% 
   rename(area_cases = area) %>% 
   select(case_date, area_cases) %>% 
   mutate(incidence_cases = if_else(area_cases > 0 & lag(area_cases) != 0,
                                    abs(lag(area_cases) - area_cases), area_cases),
          sum_cases = sum(incidence_cases)) 

incidence_dates <<- as.data.frame(rep(analysis_data$case_date, 
                                     times = analysis_data$incidence_cases)) %>% 
   rename(case_date = `rep(analysis_data$case_date, times = analysis_data$incidence_cases)`)

incidence_data <<- incidence(dates = incidence_dates$case_date)


# find and plot r value
r_results <- get_R(incidence_data, 
                   si_mean = serial_interval_mean,
                   si_sd = serial_interval_sd)
plot(r_results, main = reg_name)


# find doubing time and model fit
fit_results <- incidence::fit(incidence_data)

# plot line of fit
#plot(fit_results)

# plot line of fit over epi curve
#plot(incidence_data) %>% 
#   add_incidence_fit(fit_results) +
#   labs(title = reg_name)

}
```

# Use earlyR to calculate R0
```{r}
# select county or region
incidence_function("mt_cases", "State of Montana")
incidence_function("reg1", "Region 1")
incidence_function("reg2", "Region 2")
incidence_function("reg3", "Region 3")
incidence_function("reg4", "Region 4")
incidence_function("reg5", "Region 5")
```


```{r, eval=FALSE}
# Function for doubling time

doubing_function <- function(area, reg_name, data = reg_cases_date) {

analysis_data <- data %>% 
   rename(area_cases = area) %>% 
   select(case_date, area_cases) %>% 
   mutate(incidence_cases = if_else(area_cases > 0 & lag(area_cases) != 0,
                                    abs(lag(area_cases) - area_cases), area_cases),
          sum_cases = sum(incidence_cases)) 

incidence_dates <<- as.data.frame(rep(analysis_data$case_date, 
                                     times = analysis_data$incidence_cases)) %>% 
   rename(case_date = `rep(analysis_data$case_date, times = analysis_data$incidence_cases)`)

incidence_data <<- incidence(dates = incidence_dates$case_date)

plot(incidence_data)

# find doubing time and model fit
fit_results <- incidence::fit(incidence_data)
doubling_time <- round(fit_results$info$doubling)
doubling_time <- paste0("Doubling time = ", doubling_time, " days for ", reg_name)
doubling_time

}
```


```{r, eval=FALSE}
# Print doubling time

# select county or region
doubing_function("mt_cases", "State of Montana")
doubing_function("reg1", "Reg 1")
#doubing_function("reg2", "Region 2")
doubing_function("reg3", "Region 3")
doubing_function("reg4", "Region 4")
doubing_function("reg5", "Region 5")
```



```{r}
# Function using EpiEstim to calculate R on rolling basis

plot_function_1wk <- function(area, data = reg_cases_date) {

analysis_data <- data %>% 
   rename(area_cases = area,
          dates = case_date) %>% 
   select(dates, area_cases) %>% 
   mutate(I = if_else(area_cases > 0 & lag(area_cases) != 0,
                                    abs(lag(area_cases) - area_cases), area_cases)) %>% 
   select(dates, I)

# calculat R value
estimate_results <- estimate_R(analysis_data, method="parametric_si", 
                               config = make_config(list(mean_si = serial_interval_mean, 
                                                         std_si = serial_interval_sd)))

estimate_plots <- estimate_R_plots(estimate_results, what = "R")
estimate_plots

}

rollingr_1wk_function <- function(area, data = reg_cases_date) {

analysis_data <- data %>% 
   rename(area_cases = area,
          dates = case_date) %>% 
   select(dates, area_cases) %>% 
   mutate(I = if_else(area_cases > 0 & lag(area_cases) != 0,
                                    abs(lag(area_cases) - area_cases), area_cases)) %>% 
   select(dates, I)

# calculat R value
estimate_results <- estimate_R(analysis_data, method="parametric_si", 
                               config = make_config(list(mean_si = serial_interval_mean, 
                                                         std_si = serial_interval_sd)))

colomns <- c(1:4, 8)
tail(estimate_results$R[,colomns], 10)

}


plot_function_2wk <- function(area, data = reg_cases_date) {

analysis_data <- data %>% 
   rename(area_cases = area,
          dates = case_date) %>% 
   select(dates, area_cases) %>% 
   mutate(I = if_else(area_cases > 0 & lag(area_cases) != 0,
                                    abs(lag(area_cases) - area_cases), area_cases)) %>% 
   select(dates, I)

# calculat R value
time_var <- nrow(analysis_data)
time_start <- seq(2, time_var-13)
time_end <- time_start + 13

estimate_results <- estimate_R(analysis_data, method="parametric_si", 
                               config = make_config(list(mean_si = serial_interval_mean, 
                                                         std_si = serial_interval_sd,
                                                         t_start =  time_start,
                                                         t_end = time_end)))

estimate_plots <- estimate_R_plots(estimate_results, what = "R")
estimate_plots

}


rollingr_2wk_function <- function(area, data = reg_cases_date) {

analysis_data <- data %>% 
   rename(area_cases = area,
          dates = case_date) %>% 
   select(dates, area_cases) %>% 
   mutate(I = if_else(area_cases > 0 & lag(area_cases) != 0,
                                    abs(lag(area_cases) - area_cases), area_cases)) %>% 
   select(dates, I)

# calculat R value
time_var <- nrow(analysis_data)
time_start <- seq(2, time_var-13)
time_end <- time_start + 13

estimate_results <- estimate_R(analysis_data, method="parametric_si", 
                               config = make_config(list(mean_si = serial_interval_mean, 
                                                         std_si = serial_interval_sd,
                                                         t_start =  time_start,
                                                         t_end = time_end))) 
colomns <- c(1:4, 8)
tail(estimate_results$R[,colomns], 10)

}
```

# R-value plots using EpiEstim

# State of Montana, rolling 1 week time windows
```{r}
plot_function_1wk("mt_cases")
rollingr_1wk_function("mt_cases")
```

# State of Montana, rolling 2 week time windows
```{r}
plot_function_2wk("mt_cases")
rollingr_2wk_function("mt_cases")
```

# Region 1, rolling 1 week time windows
```{r}
plot_function_1wk("reg1")
rollingr_1wk_function("reg1")
```

# Region 1, rolling 2 week time windows
```{r}
plot_function_2wk("reg1")
rollingr_2wk_function("reg1")
```

# Region 2, rolling 1 week time windows
```{r}
plot_function_1wk("reg2")
rollingr_1wk_function("reg2")
```

# Region 2, rolling 2 week time windows
```{r}
plot_function_2wk("reg2")
rollingr_2wk_function("reg2")
```

# Region 3, rolling 1 week time windows
```{r}
plot_function_1wk("reg3")
rollingr_1wk_function("reg3")
```

# Region 3, rolling 2 week time windows
```{r}
plot_function_2wk("reg3")
rollingr_2wk_function("reg3")
```

# Region 4, rolling 1 week time windows
```{r}
plot_function_1wk("reg4")
rollingr_1wk_function("reg4")
```

# Region 4, rolling 2 week time windows
```{r}
plot_function_2wk("reg4")
rollingr_2wk_function("reg4")
```

# Region 5, rolling 1 week time windows
```{r}
plot_function_1wk("reg5")
rollingr_1wk_function("reg5")
```

# Region 5, rolling 2 week time windows
```{r}
plot_function_2wk("reg5")
rollingr_2wk_function("reg5")
```



---
title: "State of Montana Covid-19 Serial Interval Calculation"
author: "Ethan Walker"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, 
                      include = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 8, fig.height = 6)
```

```{r, message=FALSE}
library(tidyverse)
#library(plyr)
library(readxl)
library(naniar)
library(lubridate)
library(zoo)
library(eeptools)
library(knitr)
library(incidence)
library(EpiEstim)
library(earlyR)
library(projections)
library(distcrete)
library(epitrix)
library(jsonlite)
library(httr)
library(rlist)
library(Rsftp)
library(EnvStats)
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
               "#0072B2", "#D55E00", "#CC79A7")
colorblind_palette <- c("#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499", 
                        "#44AA99", "#999933", "#882255", "#661100", "#6699CC", "#888888")

file_path <- c("C:/Users/ethan.walker/Box/Ethan Walker UM/R/covid19/")
```


```{r}
# Load serial interval data
# explanation of data format: https://github.com/jstockwin/EpiEstimApp/wiki/Uploading-your-own-data
mt_si_data <- read_xlsx(paste0(file_path, "Input/SI_pair_data.xlsx"), skip = 1,
                        col_names = c("pair_no", "cluster", "infector",
                                      "infector_date", "infected", "infected_date",
                                      "EL", "ER", "SL", "SR"),
                        col_types = c("text", "text", "text",
                                      "date", "text", "date",
                                      "numeric", "numeric", "numeric", "numeric"))

mt_si_data_total <- mt_si_data %>% 
   filter(infected_date < "2020-07-31") %>% 
   dplyr::select(EL, ER, SL, SR) %>% 
   #mutate(filter_var = if_else(SR != SL, 1, 0)) %>% 
   mutate(SR = if_else(SR == 0, 1, SR)) %>% 
   #filter(filter_var == 0) %>% 
   #mutate(SR = if_else(SR == 2, 3, SR)) %>%
   #mutate(SL = SL + 1,
   #       SR = SR + 1) %>% 
   filter(SR < 29) %>% 
   mutate_all(as.integer)


mt_si_data_early <- mt_si_data %>% 
   filter(infected_date < "2020-05-01") %>% 
   dplyr::select(EL, ER, SL, SR) %>% 
   mutate(SR = if_else(SR == 0, 1, SR)) %>% 
   filter(SR < 29) %>% 
   mutate_all(as.integer)

   
mt_si_data_late <- mt_si_data %>% 
   filter(infected_date >= "2020-05-01" & infected_date < "2020-07-31") %>% 
   dplyr::select(EL, ER, SL, SR) %>% 
   mutate(SR = if_else(SR == 0, 1, SR)) %>% 
   filter(SR < 29) %>% 
   mutate_all(as.integer)


mt_si_data_pre_sip <- mt_si_data %>% 
   #filter(infected_date < "2020-03-27") %>% 
   filter(infected_date < "2020-04-10") %>% 
   dplyr::select(EL, ER, SL, SR) %>% 
   mutate(SR = if_else(SR == 0, 1, SR)) %>% 
   filter(SR < 29) %>% 
   mutate_all(as.integer)


mt_si_data_sip <- mt_si_data %>% 
   #filter(infected_date > "2020-03-27" & infected_date < "2020-04-24") %>% 
   filter(infected_date > "2020-04-10" & infected_date < "2020-05-08") %>% 
   dplyr::select(EL, ER, SL, SR) %>% 
   mutate(SR = if_else(SR == 0, 1, SR)) %>% 
   filter(SR < 29) %>% 
   mutate_all(as.integer)


mt_si_data_phase1 <- mt_si_data %>% 
   #filter(infected_date > "2020-04-25" & infected_date < "2020-05-31") %>% 
   filter(infected_date > "2020-05-08" & infected_date < "2020-06-14") %>% 
   dplyr::select(EL, ER, SL, SR) %>% 
   mutate(SR = if_else(SR == 0, 1, SR)) %>% 
   #mutate(SR = if_else(SR == 3, 4, SR)) %>%
   filter(SR < 29) %>% 
   mutate_all(as.integer)


mt_si_data_phase2 <- mt_si_data %>% 
   #filter(infected_date > "2020-05-31" & infected_date < "2020-07-31") %>% 
   filter(infected_date > "2020-06-14" & infected_date < "2020-07-31") %>% 
   dplyr::select(EL, ER, SL, SR) %>% 
   mutate(SR = if_else(SR == 0, 1, SR)) %>% 
   filter(SR < 29) %>% 
   mutate_all(as.integer)


mt_si_data_june <- mt_si_data %>% 
   filter(infected_date > "2020-05-31" & infected_date < "2020-06-30") %>% 
   dplyr::select(EL, ER, SL, SR) %>% 
   mutate(SR = if_else(SR == 0, 1, SR)) %>% 
   filter(SR < 29) %>% 
   mutate_all(as.integer)


mt_si_data_july <- mt_si_data %>% 
   filter(infected_date > "2020-06-30" & infected_date < "2020-07-31") %>% 
   dplyr::select(EL, ER, SL, SR) %>% 
   mutate(SR = if_else(SR == 0, 1, SR)) %>% 
   filter(SR < 29) %>% 
   mutate_all(as.integer)
   
   


# Load/format case data
mt_case_data <- read_xlsx(paste0(file_path, "Input/SI_Local_v_Import Data_09.10.2020.xlsx"),
                                 sheet = 2) %>% 
   rename_all(tolower) %>% 
   dplyr::select(-case_no) %>% 
   rownames_to_column(var = "case_no") %>% 
   mutate(local = if_else(local_import == 0, 1, 0),
          imported = local_import,
          date_reported = ymd(date_reported),
          dates = as.Date(symptom_onset_date),
          dates = ymd(dates),
          case = 1) %>% 
   rename(hospitalization = "ever_hospitalized") %>% 
   mutate(age_group_new = if_else(age_group == "80-89" | age_group == "90-99" | age_group == "100" | age_group == "100-110",
                               "80+", age_group),
          age_group_new = factor(age_group_new, 
                                 levels = c("0-9", "10-19", "20-29", 
                                            "30-39", "40-49", "50-59", 
                                            "60-69", "70-79", "80+"),
                                 labels = c("0 to 9", "10 to 19", "20 to 29", 
                                            "30 to 39", "40 to 49", "50 to 59", 
                                            "60 to 69", "70 to 79", "80+"))) %>% 
   mutate(hospitalization = factor(hospitalization,
                                   levels = c("Y", "N", "P", "U"),
                                   labels = c("Hosp: Yes", "Hosp: No", 
                                              "Hosp: Past", "Hosp: Unknown"))) %>% 
   #filter(!is.na(dates))
   filter(dates < "2020-08-01") %>% 
   arrange(dates) %>% 
   ungroup() %>% 
   dplyr::select(case_no, mt_case, county:hospitalization, local_import:age_group_new)
```


```{r}
#################### Run analysis and print results
## State results
# Format analysis data
# CHANGE DATE FILTER BASED ON DESIRED SI TIMEFRAME
mt_li_analysis_data <- mt_case_data %>% 
   #filter(dates < "2020-05-01" & dates >= "2020-03-01") %>% # early
   #filter(dates >= "2020-05-01" & dates < "2020-08-01") %>% # late
   #filter(dates < "2020-03-28" & dates >= "2020-03-01") %>% # pre sip
   #filter(dates >= "2020-03-28" & dates < "2020-04-26") %>% # sip
   filter(dates < "2020-06-01" & dates >= "2020-04-26") %>% # phase 1
   #filter(dates >= "2020-06-01" & dates < "2020-08-01") %>% # phase 2
   #filter(dates < "2020-07-01" & dates >= "2020-06-01") %>% # june
   #filter(dates >= "2020-07-01" & dates < "2020-08-01") %>% # july
   group_by(dates) %>% 
   mutate(local = sum(local),
          imported = sum(imported)) %>% 
   dplyr::select(dates, local, imported) %>% 
   distinct(dates, .keep_all = TRUE) %>% 
   arrange(dates)


mt_data <- mt_li_analysis_data %>% 
   mutate(I = local + imported) %>% 
   dplyr::select(dates, I) 

# CHANGE LAST DATE BASED ON DESIRED SI TIMEFRAME:
# Early = 2020-04-30; Late, July, Phase2, and Total = 2020-07-31
# PreSIP = 2020-03-27; SIP = 2020-04-25
# Phase1 = 2020-05-31; June = 2020-06-30
mt_incidence_data <- incidence(mt_data$dates, last_date = "2020-05-31")

mt_li_inc_data <- as.data.frame(mt_incidence_data$dates) %>% 
   mutate(dates = ymd(mt_incidence_data$dates)) %>% 
   dplyr::select(dates) %>% 
   left_join(mt_li_analysis_data, by = "dates") %>% 
   mutate(local = if_else(is.na(local), 0, local),
          imported = if_else(is.na(imported), 0, imported))


state_n <- as.data.frame(mt_li_inc_data$dates)
time_var <- nrow(state_n)
time_start <- seq(2, time_var-13)
time_end <- time_start + 13

## This code uses paired cases to calculate a serial interval
## I tried this code with various burnin and n1 settings, giving essentially the same results
## Once the SI is calculated from this code, the mean SI and SD SI can then be used in other files to the run analysis
## This code only needs to be used if we want to update the SI with new paired cases
MCMC_seed <- 1
overall_seed <- 2
mcmc_control <- make_mcmc_control(seed = MCMC_seed, burnin = 500, thin = 10)
dist_g <- "G"  # fitting a Gamma distribution for the SI
dist_g1 <- "off1G"  # fitting a Gamma distribution for the SI
dist_w <- "W"  # fitting a Weibull distribution for the SI
dist_l <- "L"  # fitting a Lognormal distribution for the SI
si_config <- make_config(list(si_parametric_distr = dist_g, 
                              mcmc_control = mcmc_control, seed = overall_seed, n1 = 100, n2 = 10,
                              t_start = time_start, t_end = time_end))

# CHANGE si_data INPUT DATASET BASED ON DESIRED TIMEFRAME
# mt_si_data_early, mt_si_data_late, mt_si_data_total
# mt_si_data_pre_sip, mt_si_data_sip, mt_si_data_phase1
# mt_si_data_phase2, mt_si_data_june, mt_si_data_july
mt_r_results <- estimate_R(mt_li_inc_data, method = "si_from_data", 
                           si_data = mt_si_data_pre_sip, config = si_config)
```

# Use distributions to calculate mean, sd, 95% ci's
```{r}
### Total SI calculation
# Total SI convergence successful: Mean SI = 5.51 (5.13, 5.90), SD SI = 4.62 (4.21, 5.05)

# Save/load results
total_results <- mt_r_results
write_rds(total_results, paste0(file_path, "total_results.rds"))
total_results <- read_rds(paste0(file_path, "total_results.rds"))

total_results_no_zeros <- mt_r_results
write_rds(total_results_no_zeros, paste0(file_path, "total_results_no_zeros.rds"))
total_results_no_zeros <- read_rds(paste0(file_path, "total_results_no_zeros.rds"))

# Mean/SD SI from distribution
mean_si <- total_results$SI.Moments %>% 
   summarize(mean_si = mean(Mean), sd_si = mean(Std)) 
mean_si

# Shape and scale of distribution of Means
egamma(total_results$SI.Moments$Mean, ci = TRUE)
# 95% CI for means
qgamma(c(0.025, 0.975), shape = 172.8, scale = 0.0344)

# Shape and scale of distribution of SDs
egamma(total_results$SI.Moments$Std, ci = TRUE)
# 95% CI for SDs
qgamma(c(0.025, 0.975), shape = 90.24, scale = 0.0542)


### Pre-SIP SI calculation
# Pre-SIP SI convergence successful: Mean SI = 4.62 (3.79, 5.53), SD SI = 3.67 (2.77, 4.73)

# Save/load results
presip_results <- mt_r_results
write_rds(presip_results, paste0(file_path, "presip_results.rds"))
presip_results <- read_rds(paste0(file_path, "presip_results.rds"))

# Mean/SD SI from distribution
mean_si <- presip_results$SI.Moments %>% 
   summarize(mean_si = mean(Mean), sd_si = mean(Std)) 
mean_si

# Shape and scale of distribution of Means
egamma(presip_results$SI.Moments$Mean, ci = TRUE)
# 95% CI for means
qgamma(c(0.025, 0.975), shape = 114, scale = 0.0461)

# Shape and scale of distribution of SDs
egamma(presip_results$SI.Moments$Std, ci = TRUE)
# 95% CI for SDs
qgamma(c(0.025, 0.975), shape = 64, scale = 0.0666)


### SIP SI calculation
# SIP SI convergence successful: Mean SI = 8.52 (6.88, 10.37), SD SI = 6.22 (4.61, 8.05)

# Save/load results
sip_results <- mt_r_results
write_rds(sip_results, paste0(file_path, "sip_results.rds"))
sip_results <- read_rds(paste0(file_path, "sip_results.rds"))

# Mean/SD SI from distribution
mean_si <- sip_results$SI.Moments %>% 
   summarize(mean_si = mean(Mean), sd_si = mean(Std)) 
mean_si

# Shape and scale of distribution of Means
egamma(sip_results$SI.Moments$Mean, ci = TRUE)
# 95% CI for means
qgamma(c(0.025, 0.975), shape = 92, scale = 0.0928)

# Shape and scale of distribution of SDs
egamma(sip_results$SI.Moments$Std, ci = TRUE)
# 95% CI for SDs
qgamma(c(0.025, 0.975), shape = 50, scale = 0.1242)


### Phase 1 SI calculation
# Phase 1 SI convergence successful: Mean SI = 5.35 (3.51, 7.50), SD SI = 4.69 (2.53, 7.36)

# Save/load results
phase1_results <- mt_r_results
write_rds(phase1_results, paste0(file_path, "phase1_results.rds"))
phase1_results <- read_rds(paste0(file_path, "phase1_results.rds"))

# Mean/SD SI from distribution
mean_si <- phase1_results$SI.Moments %>% 
   summarize(mean_si = mean(Mean), sd_si = mean(Std)) 
mean_si

library(goft)
library(R0)

si_data_dist <- as.numeric(mt_si_data_total$SR)

est.GT(serial.interval = si_data_dist)

si_dist <- as.data.frame(phase1_results[["si_distr"]]) %>% 
   pivot_longer(1:166, names_to = "name", values_to = "value") %>% 
   filter(value > 0)
plot(si_dist$value)
gamma_test(si_dist$value)

# Shape and scale of distribution of Means
egamma(phase1_results$SI.Moments$Mean, ci = TRUE)
# 95% CI for means
qgamma(c(0.025, 0.975), shape = 29, scale = 0.195)

# Shape and scale of distribution of SDs
egamma(phase1_results$SI.Moments$Std, ci = TRUE)
# 95% CI for SDs
qgamma(c(0.025, 0.975), shape = 14, scale = 0.331)


### Phase 2 SI calculation
# Phase 2 SI convergence successful: Mean SI = 5.29 (4.88, 5.76), SD SI = 4.45 (3.97, 4.93)

# Save/load results
phase2_results <- mt_r_results
write_rds(phase2_results, paste0(file_path, "phase2_results.rds"))
phase2_results <- read_rds(paste0(file_path, "phase2_results.rds"))

# Mean/SD SI from distribution
mean_si <- phase2_results$SI.Moments %>% 
   summarize(mean_si = mean(Mean), sd_si = mean(Std)) 
mean_si

# Shape and scale of distribution of Means
egamma(phase2_results$SI.Moments$Mean, ci = TRUE)
# 95% CI for means
qgamma(c(0.025, 0.975), shape = 559, scale = 0.0095)

# Shape and scale of distribution of SDs
egamma(phase2_results$SI.Moments$Std, ci = TRUE)
# 95% CI for SDs
qgamma(c(0.025, 0.975), shape = 324, scale = 0.0137)


mean_si_plot <- phase2_results$SI.Moments %>%
   ggplot() +
     geom_histogram(aes(Mean))
mean_si_plot

sd_si_plot <- phase2_results$SI.Moments %>%
   ggplot() +
     geom_histogram(aes(Std))
sd_si_plot



# Early SI convergence successful: Mean SI = 6.27, SD SI = 5.14
# Late SI convergence successful: Mean SI = 5.29, SD SI = 4.45
# June SI convergence successful: Mean SI = 5.26, SD SI = 4.48
# July SI convergence successful: Mean SI = 5.31, SD SI = 4.44
```


```{r}
############### Calculate R for each period using known SI 
# Format analysis data
# CHANGE DATE FILTER BASED ON DESIRED SI TIMEFRAME
mt_li_analysis_data <- mt_case_data %>% 
   #filter(dates < "2020-05-01" & dates >= "2020-03-01") %>% # early
   #filter(dates >= "2020-05-01" & dates < "2020-08-01") %>% # late
   #filter(dates < "2020-03-28" & dates >= "2020-03-01") %>% # pre sip
   #filter(dates >= "2020-03-28" & dates < "2020-04-26") %>% # sip
   #filter(dates < "2020-06-01" & dates >= "2020-04-26") %>% # phase 1
   #filter(dates >= "2020-06-01" & dates < "2020-08-01") %>% # phase 2
   #filter(dates < "2020-07-01" & dates >= "2020-06-01") %>% # june
   #filter(dates >= "2020-07-01" & dates < "2020-08-01") %>% # july
   group_by(dates) %>% 
   mutate(local = sum(local),
          imported = sum(imported)) %>% 
   dplyr::select(dates, local, imported) %>% 
   distinct(dates, .keep_all = TRUE) %>% 
   arrange(dates)


mt_data <- mt_li_analysis_data %>% 
   mutate(I = local + imported) %>% 
   dplyr::select(dates, I) 

# CHANGE LAST DATE BASED ON DESIRED SI TIMEFRAME:
# Early = 2020-04-30; Late, July, Phase2, and Total = 2020-07-31
# PreSIP = 2020-03-27; SIP = 2020-04-25
# Phase1 = 2020-05-31; June = 2020-06-30
mt_incidence_data <- incidence(mt_data$dates, last_date = "2020-07-31")

mt_li_inc_data <- as.data.frame(mt_incidence_data$dates) %>% 
   mutate(dates = ymd(mt_incidence_data$dates)) %>% 
   dplyr::select(dates) %>% 
   left_join(mt_li_analysis_data, by = "dates") %>% 
   mutate(local = if_else(is.na(local), 0, local),
          imported = if_else(is.na(imported), 0, imported))


# Total SI convergence successful: Mean SI = 5.51 (5.13, 5.90), SD SI = 4.62 (4.21, 5.05)
# Pre-SIP SI convergence successful: Mean SI = 4.62 (3.79, 5.53), SD SI = 3.67 (2.77, 4.73)
# SIP SI convergence successful: Mean SI = 8.52 (6.88, 10.37), SD SI = 6.22 (4.61, 8.05)
# Phase 1 SI convergence successful: Mean SI = 5.35 (3.51, 7.50), SD SI = 4.69 (2.53, 7.36)
# Phase 2 SI convergence successful: Mean SI = 5.29 (4.88, 5.76), SD SI = 4.45 (3.97, 4.93)
serial_interval_mean <- 5.29
serial_interval_sd <- 4.45

# Change t_end based on phase
# total = 153, pre-sip = 27, sip = 29, phase1 = 35, phase2 = 61
mt_r_results <- estimate_R(mt_li_inc_data, method = "parametric_si", 
                              config = make_config(list(mean_si = serial_interval_mean, 
                                                        std_si = serial_interval_sd,
                                                        t_start =  2,
                                                        t_end = 153)))


# Format and plot R and incidence results
colomns <- c(3, 4, 5, 8, 11)
state_r <- (mt_r_results$R[,colomns]) 
state_r


### R-numbers using data from overall period
#Total: Mean R = 1.05, SD = 0.02, Q0.025 = 1.02, Median = 1.05, Q0.975 = 1.08
#Pre-SIP: Mean R = 1.03, SD = 0.02, Q0.025 = 1.00, Median = 1.03, Q0.975 = 1.06
#SIP: Mean R = 1.13, SD = 0.02, Q0.025 = 1.10, Median = 1.13, Q0.975 = 1.17
#Phase 1: Mean R = 1.05, SD = 0.02, Q0.025 = 1.02, Median = 1.05, Q0.975 = 1.08
#Phase 2: Mean R = 1.05, SD = 0.02, Q0.025 = 1.01, Median = 1.05, Q0.975 = 1.08

### R-numbers using data from each SI period
#Total: Mean R = 1.05, SD = 0.02, Q0.025 = 1.02, Median = 1.05, Q0.975 = 1.08
#Pre-SIP: Mean R = 0.92, SD = 0.07, Q0.025 = 0.79, Median = 0.92, Q0.975 = 1.06
#SIP: Mean R = 0.78, SD = 0.07, Q0.025 = 0.65, Median = 0.78, Q0.975 = 0.93
#Phase 1: Mean R = 1.21, SD = 0.13, Q0.025 = 0.96, Median = 1.21, Q0.975 = 1.49
#Phase 2: Mean R = 1.10, SD = 0.02, Q0.025 = 1.06, Median = 1.10, Q0.975 = 1.13
```


# SI Publication Plots

```{r, fig.width = 10, fig.height = 5}
colorblind_palette <- c("#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499", 
                        "#44AA99", "#999933", "#882255", "#661100", "#6699CC", "#888888")

plot_colors <- c("#332288", "#882255", "#661100", "#6699CC", "#888888")

# Epi curve - test date
full_data <- mt_case_data %>% 
   filter(dates < "2020-08-01" & dates >= "2020-03-01")

total_cases <- sum(mt_case_data$case)
date_today <- format(Sys.Date(), "%d %b %Y")
date_14 <- format(Sys.Date() - 14, "%d %b %Y")

epi_curve_full <- full_data %>% 
   mutate(local_import = factor(local_import,
                            levels = c(1, 0),
                            labels = c("imported case", "local case"))) %>% 
   ggplot() +
     geom_rect(aes(xmin = as.Date("2020-02-28"), xmax = as.Date("2020-03-28"), ymin=0, ymax=Inf),
               fill = "gray90", alpha = 0.05) +
     geom_rect(aes(xmin = as.Date("2020-03-28"), xmax = as.Date("2020-04-26"), ymin=0, ymax=Inf),
               fill = "gray80", alpha = 0.05) +
     geom_rect(aes(xmin = as.Date("2020-04-26"), xmax = as.Date("2020-06-01"), ymin=0, ymax=Inf),
               fill = "gray90", alpha = 0.05) +
     geom_rect(aes(xmin = as.Date("2020-06-01"), xmax = as.Date("2020-08-01"), ymin=0, ymax=Inf),
               fill = "gray80", alpha = 0.05) +
     geom_col(aes(dates, case, fill = local_import), width = 1) +
     geom_text(aes(x = as.Date("2020-03-03"), y = 175, label = "A"), size = 8, color = "black") + 
     geom_text(aes(x = as.Date("2020-03-31"), y = 175, label = "B"), size = 8, color = "black") + 
     geom_text(aes(x = as.Date("2020-04-30"), y = 175, label = "C"), size = 8, color = "black") + 
     geom_text(aes(x = as.Date("2020-06-04"), y = 175, label = "D"), size = 8, color = "black") + 
     geom_label(aes(x = as.Date("2020-03-14"), y = 125,
                    label = "Pre-SIP: \n\n Cases = 291 \n SI Pairs = 68 \n\n Mean SI = 4.62 \n (95% CI: 3.79, 5.53) \n\n SD SI = 3.67 \n (95% CI: 2.77, 4.73)"),
                fill = NA, color = "black") +
     geom_label(aes(x = as.Date("2020-04-12"), y = 125, 
                    label = "SIP: \n\n Cases = 168 \n SI Pairs = 47 \n\n Mean SI = 8.52 \n (95% CI: 6.88, 10.37) \n\n SD SI = 6.22 \n (95% CI: 4.61, 8.05)"),
                fill = NA, color = "black") +
     geom_label(aes(x = as.Date("2020-05-14"), y = 125,
                    label = "Phase 1: \n\n Cases = 96 \n SI Pairs = 22 \n\n Mean SI = 5.35 \n (95% CI: 3.51, 7.50) \n\n SD SI = 4.69 \n (95% CI: 2.53, 7.36)"),
                fill = NA, color = "black") +
     geom_label(aes(x = as.Date("2020-06-16"), y = 125, 
                    label = "Phase 2: \n\n Cases = 4,217 \n SI Pairs = 372 \n\n Mean SI = 5.29 \n (95% CI: 4.88, 5.76) \n\n SD SI = 4.45 \n (95% CI: 3.97, 4.93)"),
                fill = NA, color = "black") +
     labs(fill = "") +
     ylab("Number of reported cases") +
     xlab("Date of symptom onset") +
     scale_x_date(breaks = seq.Date(from = as.Date("2020-03-01"), 
                                    to = as.Date("2020-08-01"), 
                                    by = "5 days"),
                  labels = seq.Date(from = as.Date("2020-03-01"), 
                                    to = as.Date("2020-08-01"), 
                                    by = "5 days"),
                  date_labels = "%d-%B") +
     scale_y_continuous(breaks = c(seq(0, 300, 25)), labels = c(seq(0, 300, 25))) +
     theme_minimal() +
     theme(title = element_text(size = 12, colour = "black"),
           panel.grid = element_blank(),
           panel.grid.major.y = element_line(colour = "gray50"),
           axis.text.x = element_text(size = 14, colour = "black", 
                                     angle = 90, vjust = 0.4),
           axis.text.y = element_text(size = 14, colour = "black"),
           legend.position = c(0.5, 0.35),
           axis.title.y = element_text(size = 14, colour = "black",
                                       margin = unit(c(0, 5, 0, 0), "mm")),
           axis.title.x = element_text(size = 14, colour = "black",
                                       margin = unit(c(5, 0, 0, 0), "mm")),
           legend.text = element_text(size = 14, colour = "black"),
           axis.line.x = element_blank(), 
           axis.line.y = element_blank(), 
           axis.ticks = element_blank()) +
     scale_fill_manual(values = plot_colors)   

epi_curve_full

ggsave("si_pub_epi_curve2.jpg", width = 13, height = 7, dpi = 600)
```


```{r, fig.width = 10, fig.height = 5}
colorblind_palette <- c("#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499", 
                        "#44AA99", "#999933", "#882255", "#661100", "#6699CC", "#888888")

plot_colors <- c("#332288", "#882255", "#661100", "#6699CC", "#888888")

# Epi curve - test date
full_data <- mt_case_data %>% 
   filter(dates < "2020-08-01" & dates >= "2020-03-01")

total_cases <- sum(mt_case_data$case)
date_today <- format(Sys.Date(), "%d %b %Y")
date_14 <- format(Sys.Date() - 14, "%d %b %Y")

epi_curve_full <- full_data %>% 
   mutate(local_import = factor(local_import,
                            levels = c(1, 0),
                            labels = c("imported case", "local case"))) %>% 
   ggplot() +
     geom_rect(aes(xmin = as.Date("2020-05-01"), xmax = as.Date("2020-08-01"), ymin=0, ymax=Inf),
               fill = "gray70", alpha = 0.05) +
     geom_rect(aes(xmin = as.Date("2020-02-28"), xmax = as.Date("2020-05-01"), ymin=0, ymax=Inf),
               fill = "gray50", alpha = 0.05) +
     geom_col(aes(dates, case, fill = local_import), width = 1) +
     geom_label(aes(x = as.Date("2020-03-31"), y = 125,
                    label = "Early cases: \n n = 461 \n SI Pairs = 115 \n Mean SI = 6.27 \n SD SI = 5.14"),
                fill = NA, color = "black") +
     geom_label(aes(x = as.Date("2020-06-15"), y = 125, 
                    label = "Later cases: \n n = 4311 \n SI Pairs = 394 \n Mean SI = 5.29 \n SD SI = 4.45"),
                fill = NA, color = "black") +
     labs(title = "COVID-19 cases in Montana by date of symptom onset",
          subtitle = paste0("Total cases: n = 4772, SI Pairs = 509, Mean SI = 5.51 (95% CI: 5.13, 5.90), SD SI = 4.62 (95% CI: 4.21, 5.05)"),
          fill = " ") +
     ylab("Number of Cases") +
     xlab("") +
     scale_x_date(breaks = seq.Date(from = as.Date("2020-03-01"), 
                                    to = as.Date("2020-08-01"), 
                                    by = "5 days"),
                  labels = seq.Date(from = as.Date("2020-03-01"), 
                                    to = as.Date("2020-08-01"), 
                                    by = "5 days"),
                  date_labels = "%d-%b") +
     scale_y_continuous(breaks = c(seq(0, 300, 25)), labels = c(seq(0, 300, 25))) +
     theme_minimal() +
     theme(strip.text = element_text(size = 16, colour = "black"),
           title = element_text(size = 12, colour = "black"),
           panel.grid = element_blank(),
           panel.grid.major.y = element_line(colour = "gray75"),
           axis.text.x = element_text(size = 12, colour = "black", 
                                     angle = 90, vjust = 0.4),
           axis.text.y = element_text(size = 12, colour = "black"),
           legend.position = "top",
           axis.title.y = element_text(size = 12, colour = "black",
                                       margin = unit(c(0, 5, 0, 0), "mm")),
           axis.title.x = element_text(size = 12, colour = "black",
                                       margin = unit(c(5, 0, 0, 0), "mm")),
           legend.text = element_text(size = 12, colour = "black"),
           axis.line.x = element_blank(), 
           axis.line.y = element_blank(), 
           axis.ticks = element_blank()) +
     scale_fill_manual(values = plot_colors)   

epi_curve_full

#ggsave("si_pub_epi_curve.jpg", width = 12, height = 6)
```

# Total SI convergence successful: Mean SI = 5.52, SD SI = 4.63
# Early SI convergence successful: Mean SI = 6.27, SD SI = 5.14
# Late SI convergence successful: Mean SI = 5.29, SD SI = 4.45
# Pre-SIP SI convergence successful: Mean SI = 4.62, SD SI = 3.67
# SIP SI convergence successful: Mean SI = 8.52, SD SI = 6.22
# Phase 1 SI convergence successful: Mean SI = 5.35, SD SI = 4.69
# Phase 2 SI convergence successful: Mean SI = 5.29, SD SI = 4.45
# June SI convergence successful: Mean SI = 5.26, SD SI = 4.48
# July SI convergence successful: Mean SI = 5.31, SD SI = 4.44
